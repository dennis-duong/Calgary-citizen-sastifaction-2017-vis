<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<title>Calgary Map</title>
	<style>
    path {
      stroke: white;
      stroke-width: 0.5;
    }

    body { margin:0;position:fixed;top:0;right:0;bottom:0;left:0; }
	</style>
	<script src="/scripts/d3/d3.min.js"></script>
	<script src="http://d3js.org/topojson.v0.min.js"></script>
  <script src="http://d3js.org/queue.v1.min.js"></script>
</head>
<body> 
  <div id="map"></div>
	<script>
    var width = 1000;
    var height = 1000;

    var svg = d3.select("#map")
      .append("svg")
      .attr("width", width)
      .attr("height", height);

    var projection = d3.geoMercator()
      .center([-114,51])
      .scale(70000)
      .translate([width/2, height/2]);

    var path = d3.geoPath()
      .projection(projection);

    d3.csv("Citizen_Satisfaction_Survey_2017_trimmed_2.csv").then(function(data) {

      var dataByWards = d3.nest()
        .key(function(d) {return d.Ward;})
        .entries(data);


      var dataByWardsMetrics = d3.nest()
        .key(function(d) {return d.Ward;})
        .rollup(function(v) {return {
          responses: v.length, 
          avgAge: d3.mean(v, function(d) {return d.Age;}),
          avgQOL: d3.mean(v, function(d) {return d.QOL;}),
          avgCalgaryLiving: d3.mean(v, function(d) {return d.Calgary_living;}),
          avgCalgaryLife: d3.mean(v, function(d) {return d.Calgary_life;}),
          avgNS: d3.mean(v, function(d) {return d.Neighbourhood_Safety;})
        }; })
        .entries(data);

      var genderCountbyWards = d3.nest()
        .key(function(d) {return d.Ward;})
        .key(function(d) {return d.Gender;})
        .rollup(function(v) {return v.length;})
        .entries(data);

      //console.log(dataByWardsMetrics[0].value.avgQOL);

      d3.json("Ward_Boundaries.geojson").then(function(data) {
        var count = -1;

        var color = d3.scaleLinear()
          .domain([7,8])
          .range(["#ccf5ff", "#005266"]);

        svg.selectAll("path")
          .data(data.features)
          .enter()
          .append("path")
          .attr("d", path)
          .attr("fill", function(d) {
            count++;
            for (var i = 0; i<dataByWardsMetrics.length; i++) {
              var tmp1 = ""+dataByWardsMetrics[i].key;
              var tmp2 = "Ward "+data.features[count].properties.ward_num;
              // console.log(dataByWardsMetrics[i].key);
              // console.log( "Ward "+data.features[count].properties.ward_num);
              if (tmp1.localeCompare(tmp2) == 0) {
                console.log("ward_"+data.features[count].properties.ward_num); 
                console.log(dataByWardsMetrics[i].value.avgQOL); 
                console.log(color(dataByWardsMetrics[i].value.avgQOL));
                return color(dataByWardsMetrics[i].value.avgQOL);
              } 
            }
        });

        var legend = svg.append("g");

        var legenditem = legend.selectAll(".legenditem")
          .data(d3.range(10))
          .enter()
          .append("g")
          .attr("transform", function (d,i) { 
            return "translate(0,"+i*33+")";
          });

        legenditem.append("rect")
          .attr("x", width - 300)
          .attr("y", 50)
          .attr("width", 6)
          .attr("height", 30)
          .style("fill", function(d,i) {
            return color(i/10+7);
          })

        legenditem.append("text")
          .attr("x", width - 270)
          .attr("y", 70)
          .style("text-anchor", "middle")
          .text(function(d, i) { return d3.format("0.2f")(i/10+7); });

      });
    });
	</script>
</body>
</html>