<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<title>Calgary Map</title>
	<style>
    body, h1, h2, h3, p {
      margin: 0;
      padding: 0;
      font-family: 'Source Sans Pro', sans-serif;
      font-size: 12px;
      color: #333;
      font-weight: 400;
    }
    body {
      overflow: auto
    }
    path {
      stroke-width: 0.3;
    }
    .label {
      fill: white;
      font-size: 16px;
      font-weight: bold;
    }
    svg {
      position:relative;
    }
	</style>
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">
  <script src="https://code.jquery.com/jquery-3.2.1.slim.min.js" integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN" crossorigin="anonymous"></script>
	<script src="scripts/d3/d3.min.js"></script>
	<script src="http://d3js.org/topojson.v0.min.js"></script>
  <script src="http://d3js.org/queue.v1.min.js"></script>
</head>
<body>
  <div class="container m-2">
  <div class="row">
    <div class="form-group col-4">
      <label for="sel1">Select:</label>
      <select class="form-control" id="sel1" onChange="updateMap(this.value)">
        <option value="avgAge">1</option>
        <option value="avgQOL">2</option>
        <option value="avgCalgaryLife">3</option>
        <option value="avgCalgaryLiving">4</option>
        <option value="avgNS">5</option>
      </select>
    </div>
  </div>
    <div class = "row">
      <div class = "svg-container">
      </div>
    </div>
  </div>
	<script>

    function sortData(data) {
      return data.sort(function(a,b) {
          return +a.key.split(" ")[1] - +b.key.split(" ")[1];
        });
    };

    function updateMap(value) {
      console.log(value);

      var min = Math.floor(d3.min(sortedDataByWards,function(d){
        return d.value[value];
      }));
      console.log(min);
      var max = Math.ceil(d3.max(sortedDataByWards,function(d){
        return d.value[value];
      }));
      console.log(max);

      var minColor = "#e6f2ff";
      var maxColor = "#00264d";

      var color = d3.scaleLinear()
        .domain([min,max])
        .range([minColor,maxColor]);


      var wards = svg.selectAll(".wardPaths")
        .transition()
        .style("fill", function(d, i) {
          //console.log(d.properties.ward_num);
          return color(sortedDataByWards[d.properties.ward_num-1].value[value]);
        })

        var label = svg.selectAll(".label")
          .transition()
          .attr("transform", function(d) { 
            if (value=="avgAge") {
              return "translate( " + (path.centroid(d)[0]-15) + "," + (path.centroid(d)[1]+15) + ")"; 
            } else {
              return "translate( " + (path.centroid(d)[0]-10) + "," + (path.centroid(d)[1]+15) + ")"; 
            }
          })
          .text(function(d, i) { return d3.format("0.1f")(sortedDataByWards[d.properties.ward_num-1].value[value])
          });
    }

    var width = 1000;
    var height = 1000;

    var jsonData;
    var sortedDataByWards;

    var barGraphSvg = d3.select(".svg-container")
      .append("svg")
      .attr("width", 1200)
      .attr("height", 400);

    var svg = d3.select(".svg-container")
      .append("svg")
      .attr("width", width)
      .attr("height", height);

    var projection = d3.geoMercator()
      .center([-114,51])
      .scale(60000)
      .translate([width/2, height/2]);

    var path = d3.geoPath()
      .projection(projection);

    d3.csv("Citizen_Satisfaction_Survey_2017_trimmed_2.csv").then(function(data) {

      var databyWardsAll = d3.nest()
        .key(function(d) {return d.Ward;})
        .entries(data);

      var sortedDataByWardsAll = sortData(databyWardsAll);

      console.log(sortedDataByWardsAll);

      var dataByWards = d3.nest()
        .key(function(d) {return d.Ward;})
        .rollup(function(v) {return {
          responses: v.length, 
          avgAge: d3.mean(v, function(d) {return d["Average Age"];}),
          avgQOL: d3.mean(v, function(d) {return d["Average Quality of Life Rating (1-10)"];}),
          avgCalgaryLiving: d3.mean(v, function(d) {return d["Average Living in Calgary Rating (1-10)"];}),
          avgCalgaryLife: d3.mean(v, function(d) {return d["Average Life in Cangary Rating (1-10)"];}),
          avgNS: d3.mean(v, function(d) {return d["Average Neighbourhood Safety Rating (1-4)"];})
        }; })
        .entries(data);

      sortedDataByWards = sortData(dataByWards);

      console.log(sortedDataByWards);

      var genderCountbyWards = d3.nest()
        .key(function(d) {return d.Ward;})
        .key(function(d) {return d.Gender;})
        .rollup(function(v) {return v.length;})
        .entries(data);

      var minorityCountbyWards = d3.nest()
        .key(function(d) {return d.Ward;})
        .key(function(d) {return d["Member of Visible Minority"];})
        .rollup(function(v) {return v.length;})
        .entries(data);

      var livingWithChildrenCountbyWards = d3.nest()
        .key(function(d) {return d.Ward;})
        .key(function(d) {return d["Living with Children"];})
        .rollup(function(v) {return v.length;})
        .entries(data);

      var x = d3.scaleBand()
          .range([0, width])
          .padding(0.1);
      var y = d3.scaleLinear()
          .range([height, 0]);

      var barGraph = barGraphSvg.append("g")

      x.domain([1,2,3,4,5,6,7,8,9,10,11,12,13,14]);
      y.domain(0, d3.max(sortedDataByWards,function(d){ 
        return d.value["responses"];
      }));
          
      var bars = barGraphSvg.selectAll(".bar")
        .data(sortedDataByWards)
        .enter()
        .append("rect")
        .attr("class", "bar") 
        .attr("x", function(d) { console.log(d); return 75*d.key.split(" ")[1]; })
        .attr("width", 50)
        .attr("y", function(d) { return d.value.responses; })
        .attr("height", function(d) { return height-d.value.responses; });


      d3.json("Ward_Boundaries.geojson").then(function(data) {

        jsonData = data;

        value = "avgAge";

        var min = Math.floor(d3.min(sortedDataByWards,function(d){
          return d.value[value];
        }));
        console.log(min);
        var max = Math.ceil(d3.max(sortedDataByWards,function(d){
          return d.value[value];
        }));
        console.log(max);

        var minColor = "#e6f2ff";
        var maxColor = "#00264d";

        var color = d3.scaleLinear()
          .domain([min,max])
          .range([minColor,maxColor]);

        var map = svg.append("g");

        var wards = map.selectAll("path")
          .data(data.features)
          .enter()
          .append("path")
          .attr("class", "wardPaths")
          .attr("d", path)
          .style("stroke", "white")
          .style("fill", function(d, i) {
            //console.log(d.properties.ward_num);
            return color(sortedDataByWards[d.properties.ward_num-1].value[value]);
          })

        /*var circles = map.selectAll("circle")
          .data(data.features)
          .enter()
          .append("circle")
          .attr("cx", function(d) { return path.centroid(d)[0] })
          .attr("cy",  function(d) { return (path.centroid(d)[1]+10) })
          .attr("r", "25")
          .style("fill", "black");*/

        var label = map.selectAll(".label")
          .data(data.features)
          .enter()
          .append("text")
            .attr("class", "label")
            .attr("transform", function(d) { return "translate( " + (path.centroid(d)[0]-15) + "," + (path.centroid(d)[1]+15) + ")"; })
            .text(function(d, i) { return d3.format("0.1f")(sortedDataByWards[d.properties.ward_num-1].value[value])
            });

        var legend = map.append("g");

        var legenditem = legend.selectAll(".legenditem")
          .data(d3.range(6))
          .enter()
          .append("g")
          .attr("transform", function (d,i) { 
            return "translate(0,"+i*33+")";
          });

        legenditem.append("rect")
          .attr("x", width - 250)
          .attr("y", 70)
          .attr("width", 6)
          .attr("height", 30)
          .style("fill", function(d,i) {
            return color(i*2/10+min);
          })

        legenditem.append("text")
          .attr("x", width - 225)
          .attr("y", 90)
          .style("text-anchor", "middle")
          .text(function(d, i) { return d3.format("0.1f")(i*2/10+min); });
      });
    });
	</script>
</body>
</html>