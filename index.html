<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<title>Calgary Map</title>
	<style>
    body, h1, h2, h3, p {
      margin: 0;
      padding: 0;
      font-family: 'Source Sans Pro', sans-serif;
      font-size: 12px;
      color: #333;
      font-weight: 400;
    }
    body {
      overflow: auto
    }
    path {
      stroke-width: 0.3;
    }
    .label {
      fill: white;
      font-size: 16px;
      font-weight: bold;
    }
    .slice_label {
      fill: white;
      font-size: 16px;
    }
    .slice_percentages {
      fill: white;
      font-size: 16px;
    }
    svg {
      position:relative;
    }

    .tooltip {
      position: absolute;
      padding: 7px;
      font-size: 1em;
      pointer-events: none;
      background: #fff;
      border: 1px solid #ccc;
      border-radius: 4px;

      -moz-box-shadow:    3px 3px 10px 0px rgba(0, 0, 0, 0.25);
      -webkit-box-shadow: 3px 3px 10px 0px rgba(0, 0, 0, 0.25);
      box-shadow:         3px 3px 10px 0px rgba(0, 0, 0, 0.25);
    }

    .tooltip p {
      margin: 0;
      padding: 0;
    }

    .tooltip table {
      margin: 0;
      padding: 0;
      border-collapse: collapse;
    }
	</style>
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">
  <script src="https://code.jquery.com/jquery-3.2.1.slim.min.js" integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN" crossorigin="anonymous"></script>
	<script src="scripts/d3/d3.min.js"></script>
	<script src="http://d3js.org/topojson.v0.min.js"></script>
  <script src="http://d3js.org/queue.v1.min.js"></script>
</head>
<body>
  <div class="container-fluid m-2 h-100">
  <div class="row h-100">
    <div class="col-1"></div>
    <div class="form-group col-4">
      <label for="sel1"></label>
      <select class="form-control" id="sel1" onChange="updateMap(this.value)">
        <option value="avgAge" selected>Average Age</option>
        <option value="avgQOL" selected>Overall quality of life in the City of Calgary rating (1-10)</option>
        <option value="avgCalgaryLife">Calgary is a great place to make a life rating. (1-10)</option>
        <option value="avgCalgaryLiving">Calgary is a great place to make a living rating. (1-10)</option>
        <option value="avgNS">How safe do you feel walking alone in your neighborhood after dark rating (1-4)</option>
      </select>
    </div>
  </div>
    <div class = "">
      <div class = "svg-container"></div>
      <div class = "bar-graph-container"></div>
    </div>
  </div>
	<script>

    function sortData(data) {
      return data.sort(function(a,b) {
          return +a.key.split(" ")[1] - +b.key.split(" ")[1];
        });
    };

    var width = 1200;
    var height = 800;

    var h_width = 800;
    var h_height = 400;

    var jsonData;
    var sortedDataByWards;
    var pie_data;
    var sortedGenderCounts;
    var pie;
    var arcs;

    var tooltip = d3.select("body").append("div")
      .attr("class", "tooltip")
      .style("opacity", 0);

    var svg = d3.select(".svg-container")
      .append("svg")
      .attr("width", width)
      .attr("height", height);

    var projection = d3.geoMercator()
      .center([-114,51])
      .scale(60000)
      .translate([width/2-100, height/2]);

    var path = d3.geoPath()
      .projection(projection);

    d3.csv("Citizen_Satisfaction_Survey_2017_trimmed_2.csv").then(function(data) {

      var databyWardsAll = d3.nest()
        .key(function(d) {return d.Ward;})
        .entries(data);

      var sortedDataByWardsAll = sortData(databyWardsAll);

      console.log(sortedDataByWardsAll);

      var dataByWards = d3.nest()
        .key(function(d) {return d.Ward;})
        .rollup(function(v) {return {
          responses: v.length, 
          avgAge: d3.mean(v, function(d) {return d["Average Age"];}),
          avgQOL: d3.mean(v, function(d) {return d["Average Quality of Life Rating (1-10)"];}),
          avgCalgaryLiving: d3.mean(v, function(d) {return d["Average Living in Calgary Rating (1-10)"];}),
          avgCalgaryLife: d3.mean(v, function(d) {return d["Average Life in Cangary Rating (1-10)"];}),
          avgNS: d3.mean(v, function(d) {return d["Average Neighbourhood Safety Rating (1-4)"];})
        }; })
        .entries(data);

      sortedDataByWards = sortData(dataByWards);

      console.log(sortedDataByWards);

      var genderCountbyWards = d3.nest()
        .key(function(d) {return d.Ward;})
        .key(function(d) {return d.Gender;})
        .rollup(function(v) {return v.length;})
        .entries(data);

      sortedGenderCounts = sortData(genderCountbyWards);

      console.log(sortedGenderCounts[0].values);

      var minorityCountbyWards = d3.nest()
        .key(function(d) {return d.Ward;})
        .key(function(d) {return d["Member of Visible Minority"];})
        .rollup(function(v) {return v.length;})
        .entries(data);

      sortedMinorityCounts = sortData(minorityCountbyWards);

      var livingWithChildrenCountbyWards = d3.nest()
        .key(function(d) {return d.Ward;})
        .key(function(d) {return d["Living with Children"];})
        .rollup(function(v) {return v.length;})
        .entries(data);

      sortedLivingWithChildrenCount = sortData(livingWithChildrenCountbyWards);

      var Title = svg.append("text")
        .attr("class", "pie_title")
        .attr("x", 875)             
        .attr("y", 25)
        .attr("text-anchor", "left")  
        .style("font-size", "20px") 
        .text("Ward 1");


      pie_data = sortedGenderCounts[0].values;

      pie = svg.append("g")
        .attr("transform", "translate(900,200)")

      var slice_data = d3.pie()
        .value(function(d) {return d.value;})
        (pie_data)
      
      console.log(slice_data);

      var pie_color = d3.scaleOrdinal(d3.schemeSet1);

      arcs = d3.arc()
        .innerRadius(0)
        .outerRadius(100)
        .padRadius(50);

      var slices = pie.selectAll("path")
        .data(slice_data)
        .enter()
        .append("path")
        .attr("class", "slice_path")
        .attr("d", arcs)
        .style("fill", function(d) {
          return pie_color(d.data.key);
        })

      slices
        .on("mouseover", function(d) {
            console.log(d);
            tooltip.transition()
            .duration(250)
            .style("opacity", 1);
            tooltip.html(
              "<p><strong>"+d.data.key+"</strong></p>"
              +"<table><tbody>"
              +"<tr><td>"
              + "Number:&nbsp;"
              +"</td><td>"
              + d.data.value
              +"</td></tr>"
              +"<tr><td>"
              +"</tbody></table>"
            )
            .style("left",  (d3.event.pageX + 15) + "px")
            .style("top", (d3.event.pageY - 28) + "px");
          })
          .on("mouseout", function(d) {
            tooltip.transition()
            .duration(250)
            .style("opacity", 0);
          })

      var slice_label = pie.selectAll(".slice_label")
        .data(slice_data)
        .enter()
        .append("text")
        .attr("pointer-events", "none")
        .attr("class", "slice_label")
        .attr("x", function(d){ return(arcs.centroid(d)[0])-20})
        .attr("y", function(d){ return(arcs.centroid(d)[1])})
        .text(function(d, i) { return d.data.key})

      var slice_percentages = pie.selectAll(".slice_percentages")
        .data(slice_data)
        .enter()
        .append("text")
        .attr("pointer-events", "none")
        .attr("class", "slice_percentages")
        .attr("x", function(d){ return(arcs.centroid(d)[0])-20})
        .attr("y", function(d){ return(arcs.centroid(d)[1])+20})
        .text(function(d, i) { return d3.format("0.0f")(d.value/sortedDataByWards[0].value["responses"]*100)+"%";})

      var Title = svg.append("text")
        .attr("class", "pie_subtitle")
        .attr("x", 865)             
        .attr("y", 75)
        .attr("text-anchor", "left")  
        .style("font-size", "20px") 
        .text("Gender?");


      //////////////////////////////////////////////////////////////////////////////////////////////
      //////////////////////////////////////////////////////////////////////////////////////////////

      pie_data2 = sortedLivingWithChildrenCount[0].values;

      pie2 = svg.append("g")
        .attr("transform", "translate(900,500)")

      var slice_data2 = d3.pie()
        .value(function(d) {return d.value;})
        (pie_data2)
      
      console.log(slice_data2);

      var pie_color2 = d3.scaleOrdinal(d3.schemeSet1);

      arcs2 = d3.arc()
        .innerRadius(0)
        .outerRadius(100)
        .padRadius(50);

      var slices2 = pie2.selectAll("path")
        .data(slice_data2)
        .enter()
        .append("path")
        .attr("class", "slice_path")
        .attr("d", arcs2)
        .style("fill", function(d) {
          return pie_color(d.data.key);
        })

      slices2
        .on("mouseover", function(d) {
            console.log(d);
            tooltip.transition()
            .duration(250)
            .style("opacity", 1);
            tooltip.html(
              "<p><strong>"+d.data.key+"</strong></p>"
              +"<table><tbody>"
              +"<tr><td>"
              + "Number:&nbsp;"
              +"</td><td>"
              + d.data.value
              +"</td></tr>"
              +"<tr><td>"
              +"</tbody></table>"
            )
            .style("left",  (d3.event.pageX + 15) + "px")
            .style("top", (d3.event.pageY - 28) + "px");
          })
          .on("mouseout", function(d) {
            tooltip.transition()
            .duration(250)
            .style("opacity", 0);
          })

      var slice_label2 = pie2.selectAll(".slice_label")
        .data(slice_data2)
        .enter()
        .append("text")
        .attr("pointer-events", "none")
        .attr("class", "slice_label")
        .attr("x", function(d){ return(arcs.centroid(d)[0])-20})
        .attr("y", function(d){ return(arcs.centroid(d)[1])})
        .text(function(d, i) { return d.data.key})

      var slice_percentages2 = pie2.selectAll(".slice_percentages")
        .data(slice_data2)
        .enter()
        .append("text")
        .attr("pointer-events", "none")
        .attr("class", "slice_percentages")
        .attr("x", function(d){ return(arcs.centroid(d)[0])-20})
        .attr("y", function(d){ return(arcs.centroid(d)[1])+20})
        .text(function(d, i) { return d3.format("0.0f")(d.value/sortedDataByWards[0].value["responses"]*100)+"%";})

        var Title2 = svg.append("text")
        .attr("class", "pie_subtitle")
        .attr("x", 825)             
        .attr("y", 375)
        .attr("text-anchor", "left")  
        .style("font-size", "20px") 
        .text("Living with children?");

      //////////////////////////////////////////////////////////////////////////////////////////////
      //////////////////////////////////////////////////////////////////////////////////////////////

      d3.json("Ward_Boundaries.geojson").then(function(data) {

        jsonData = data;

        value = "avgAge";

        var min = Math.floor(d3.min(sortedDataByWards,function(d){
          return d.value[value];
        }));
        var max = Math.ceil(d3.max(sortedDataByWards,function(d){
          return d.value[value];
        }));

        var minColor = "#80ff80";
        var maxColor = "#004d00";

        var color = d3.scaleLinear()
          .domain([min,max])
          .range([minColor,maxColor]);

        var map = svg.append("g")
          .attr("class", "map");

        var wards = map.selectAll("path")
          .data(data.features)
          .enter()
          .append("path")
          .attr("class", "wardPaths")
          .attr("d", path)
          .style("stroke", "white")
          .style("fill", function(d, i) {
            //console.log(d.properties.ward_num);
            return color(sortedDataByWards[d.properties.ward_num-1].value[value]);
          })

        wards
          .on("mouseover", function(d) {
            tooltip.transition()
            .duration(250)
            .style("opacity", 1);
            tooltip.html(
              "<p><strong>"+d.properties.label+"</strong></p>"
              +"<table><tbody>"
              +"<tr><td>"
              + "Number of Responses:&nbsp;"
              +"</td><td>"
              + sortedDataByWards[d.properties.ward_num-1].value["responses"]
              +"</td></tr>"
              +"<tr><td>"
              + "Number of " + sortedGenderCounts[d.properties.ward_num-1].values[0].key +":&nbsp;"
              +"</td><td>"
              + sortedGenderCounts[d.properties.ward_num-1].values[0].value
              +"</td></tr>"
              +"<tr><td>"
              + "Number of " + sortedGenderCounts[d.properties.ward_num-1].values[1].key +":&nbsp;"
              +"</td><td>"
              + sortedGenderCounts[d.properties.ward_num-1].values[1].value
              +"</td></tr>"
              +"</tbody></table>"
            )
            .style("left", path.centroid(d)[0] + "px")
            .style("top", path.centroid(d)[1] + "px");
          })
          .on("mouseout", function(d) {
            tooltip.transition()
            .duration(250)
            .style("opacity", 0);
          })
          .on("click", function(d) {
            updatePie(d);
          })

        var Title = svg.append("text")
          .attr("x", 350)             
          .attr("y", 25)
          .attr("text-anchor", "left")  
          .style("font-size", "20px") 
          .text("Wards of Calgary");

        /*var circles = map.selectAll("circle")
          .data(data.features)
          .enter()
          .append("circle")
          .attr("cx", function(d) { return path.centroid(d)[0] })
          .attr("cy",  function(d) { return (path.centroid(d)[1]+10) })
          .attr("r", "25")
          .style("fill", "black");*/

        var label = map.selectAll(".label")
          .data(data.features)
          .enter()
          .append("text")
            .attr("pointer-events", "none")
            .attr("class", "label")
            .attr("transform", function(d) { return "translate( " + (path.centroid(d)[0]-15) + "," + (path.centroid(d)[1]+15) + ")"; })
            .text(function(d, i) { return d3.format("0.1f")(sortedDataByWards[d.properties.ward_num-1].value[value])
            });


        var legend = map.append("g");

        var legenditem = legend.selectAll(".legenditem")
          .data(d3.range(6))
          .enter()
          .append("g")
          .attr("transform", function (d,i) { 
            return "translate(0,"+i*33+")";
          });

        legenditem.append("rect")
          .attr("class", "legend-rect")
          .attr("x", width - 520)
          .attr("y", 70)
          .attr("width", 6)
          .attr("height", 30)
          .style("fill", function(d,i) {
            return color(i*((max-min)/6)+min);
          })

        // legenditem.append("text")
        //   .attr("x", width - 270)
        //   .attr("y", 90)
        //   .style("text-anchor", "middle")
        //   .text(function(d, i) { return d3.format("0.1f")(i*2/10+min); });

        legend.append("text")
          .attr("class", "legend-min")
          .attr("x", width - 500)
          .attr("y", 90)
          .style("text-anchor", "middle")
          .text(min);

        legend.append("text")
          .attr("class", "legend-max")
          .attr("x", width - 500)
          .attr("y", 8*32)
          .style("text-anchor", "middle")
          .text(max);
      });
    });

    function updateMap(value) {
      console.log(value);

      var min = Math.floor(d3.min(sortedDataByWards,function(d){
        return d.value[value];
      }));
      console.log(min);
      var max = Math.ceil(d3.max(sortedDataByWards,function(d){
        return d.value[value];
      }));
      if(value=="avgCalgaryLife") {
        max = 8.1;
      }
      console.log(max);

      var minColor = "#e6f2ff";
      var maxColor = "#00264d";

      if(value=="avgNS") {
        minColor = "#d6d6f5";
        maxColor = "#24248f";
      }
      if (value=="avgAge") {
        minColor = "#80ff80";
        maxColor = "#004d00";
      }

      var color = d3.scaleLinear()
        .domain([min,max])
        .range([minColor,maxColor]);


      var wards = svg.selectAll(".wardPaths")
        .transition()
        .style("fill", function(d, i) {
          //console.log(d.properties.ward_num);
          return color(sortedDataByWards[d.properties.ward_num-1].value[value]);
        })

      var label = svg.selectAll(".label")
        .transition()
        .attr("transform", function(d) { 
          if (value=="avgAge") {
            return "translate( " + (path.centroid(d)[0]-15) + "," + (path.centroid(d)[1]+15) + ")"; 
          } else {
            return "translate( " + (path.centroid(d)[0]-10) + "," + (path.centroid(d)[1]+15) + ")"; 
          }
        })
        .text(function(d, i) { return d3.format("0.1f")(sortedDataByWards[d.properties.ward_num-1].value[value])
        });

      var legendmin = svg.selectAll(".legend-min")
        .transition()
        .text(min);

      var legendmax = svg.selectAll(".legend-max")
        .transition()
        .text(max);

      var legendRect = svg.selectAll(".legend-rect")
        .transition()
        .style("fill", function(d,i) {
          return color(i*((max-min)/6)+min);
        })
    }

    function updatePie(d) {
      pie_data = sortedGenderCounts[d.properties.ward_num-1].values;
      console.log(pie_data[0]);
      console.log(pie_data[1]);
      if(pie_data[0].key == "Male") {
        var temp = pie_data[0];
        pie_data[0] = pie_data[1];
        pie_data[1] = temp;
      }

      var pie_color = d3.scaleOrdinal(d3.schemeSet1);

      var slice_data = d3.pie()
        .value(function(d) {return d.value;})
        (pie_data)

      var pie_color = d3.scaleOrdinal(d3.schemeSet1);

      arcs = d3.arc()
        .innerRadius(0)
        .outerRadius(100)
        .padRadius(50);

      var slices = svg.selectAll(".slice_path")
        .data(slice_data)
       
      slices
        /*.transition()*/
        .attr("d", arcs)

      var slice_label = pie.selectAll(".slice_label")
        .data(slice_data)

      slice_label
        .transition()
        .attr("x", function(d){ return(arcs.centroid(d)[0])-20})
        .attr("y", function(d){ return(arcs.centroid(d)[1])})
        .text(function(d, i) { return d.data.key})

      var slice_percentages = pie.selectAll(".slice_percentages")
        .data(slice_data)
        
      var p_divisor = sortedDataByWards[d.properties.ward_num-1].value["responses"];

      slice_percentages
        .transition()
        .attr("x", function(d){ return(arcs.centroid(d)[0])-20})
        .attr("y", function(d){ return(arcs.centroid(d)[1])+20})
        .text(function(d, i) { return d3.format("0.0f")(d.value/p_divisor*100)+"%";})



      var title = svg.selectAll(".pie_title")
        .transition()
        .text(d.properties.label);
    }
	</script>
</body>
</html>